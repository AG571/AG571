name: Daily README heartbeat
on:
  schedule:
    - cron: "15 07 * * *"   # daily 07:15 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  heartbeat:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update README section
        shell: bash
        run: |
          set -euo pipefail
          FILE="README.md"
          START="<!-- TIL-START -->"
          END="<!-- TIL-END -->"

          # Ensure markers exist
          if ! grep -q "$START" "$FILE" || ! grep -q "$END" "$FILE"; then
            {
              echo ""
              echo "$START"
              echo "**Today I learned:** First heartbeat • $(date -u +'%Y-%m-%d')"
              echo "$END"
            } >> "$FILE"
          else
            python3 - <<'PY'
import re, random, datetime
fn = "README.md"
with open(fn, "r", encoding="utf-8") as f:
    txt = f.read()
start = "<!-- TIL-START -->"
end = "<!-- TIL-END -->"
facts = [
    "Read about agentic AI workflows.",
    "Improved automation logic.",
    "Explored new ML evaluation tools.",
    "Refined dataset structure.",
    "Reviewed AI reliability papers."
]
today = datetime.datetime.utcnow().strftime("%Y-%m-%d")
block = f"{start}\n**Today I learned:** {random.choice(facts)} • {today}\n{end}"
new = re.sub(start + r".*?" + end, block, txt, flags=re.S)
with open(fn, "w", encoding="utf-8") as f:
    f.write(new)
PY
          fi

      - name: Commit and push
        env:
          GH_TOKEN: ${{ secrets.PAT_PUSH }}
        run: |
          git config user.name "Aviv Geron"
          git config user.email "geron.aviv@hotmail.com"
          if ! git diff --quiet; then
            git add README.md
            git commit -m "chore: daily heartbeat update"
            git push https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }} HEAD:main
          else
            echo "No changes to commit."
          fi
