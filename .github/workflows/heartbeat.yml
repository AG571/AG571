name: Daily heartbeat

on:
  workflow_dispatch:
  schedule:
    - cron: '15 07 * * *'  # every day at 07:15 UTC

permissions:
  contents: write

jobs:
  hb:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml

      - name: Build AI news summary and update README
        run: |
          import requests, re, datetime, pathlib

          README_PATH = pathlib.Path("README.md")
          START = "<!--START_HEARTBEAT-->"
          END = "<!--END_HEARTBEAT-->"
          today = datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC")

          # Fetch top AI news
          try:
              resp = requests.get("https://api.thenewsapi.com/v1/news/all?search=artificial%20intelligence&language=en&api_token=demo")
              data = resp.json().get("data", [])[:3]
              news = "\n".join([f"- [{n['title']}]({n['url']})" for n in data]) if data else "No new AI news today."
          except Exception as e:
              news = f"(Error fetching news: {e})"

          block = f"{START}\n\n**Last update:** {today}\n\n{news}\n\n{END}"

          readme = README_PATH.read_text(encoding="utf-8")
          pattern = re.compile(f"{START}[\\s\\S]*?{END}", re.M)
          updated = pattern.sub(block, readme) if pattern.search(readme) else readme.rstrip() + "\n\n" + block
          README_PATH.write_text(updated, encoding="utf-8")

      - name: Commit and push
        env:
          GH_TOKEN: ${{ secrets.PAT_PUSH }}
        shell: bash
        run: |
          set -euxo pipefail

          git config user.name "Aviv Geron"
          git config user.email "geron.aviv@hotmail.com"

          echo "Repo: ${{ github.repository }}"
          echo "Branch (ref): ${GITHUB_REF_NAME:-$(git rev-parse --abbrev-ref HEAD)}"

          # Show status before deciding to commit
          git status --porcelain || true

          if ! git diff --quiet -- README.md; then
            git add README.md
            git commit -m "chore: daily AI news summary"
            git push "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git" HEAD:${GITHUB_REF_NAME:-main}
          else
            echo "No changes to commit"
          fi
