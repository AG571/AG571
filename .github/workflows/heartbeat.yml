name: Daily heartbeat

on:
  workflow_dispatch:
  schedule:
    - cron: '15 07 * * *'  # daily at 07:15 UTC

permissions:
  contents: write

jobs:
  hb:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # No dependency install step needed anymore

      - name: Build AI news summary and update README
        env:
          README_PATH: README.md
        shell: bash
        run: |
          python << 'PY'
          from pathlib import Path
          import re
          import json
          import datetime as dt
          import urllib.request
          import ssl

          README_PATH = Path("README.md")
          START = "<!--START_HEARTBEAT-->"
          END = "<!--END_HEARTBEAT-->"

          def fetch_json(url: str):
            """Fetch JSON using stdlib urllib (no external deps)."""
            ctx = ssl.create_default_context()
            ctx.check_hostname = False
            ctx.verify_mode = ssl.CERT_NONE
            with urllib.request.urlopen(url, context=ctx, timeout=10) as resp:
              data = resp.read()
            return json.loads(data.decode("utf-8"))

          articles = []

          # 1) Hacker News (Algolia API) - AI related stories
          try:
            hn_url = (
              "https://hn.algolia.com/api/v1/search_by_date"
              "?tags=story&query=AI&hitsPerPage=10"
            )
            hn_data = fetch_json(hn_url)
            for hit in hn_data.get("hits", []):
              title = hit.get("title") or hit.get("story_title")
              url = hit.get("url") or hit.get("story_url")
              if title and url:
                articles.append((title.strip(), url, "Hacker News"))
          except Exception as e:
            print("HN fetch error:", e)

          # 2) StackExchange AI site - recent questions
          try:
            se_url = (
              "https://api.stackexchange.com/2.3/questions"
              "?order=desc&sort=activity&tagged=artificial-intelligence"
              "&site=ai&pagesize=10"
            )
            se_data = fetch_json(se_url)
            for q in se_data.get("items", []):
              title = q.get("title")
              url = q.get("link")
              if title and url:
                articles.append((title.strip(), url, "StackExchange AI"))
          except Exception as e:
            print("StackExchange fetch error:", e)

          # Fallback if everything fails
          if not articles:
            articles = [
              (
                "How to learn AI from first principles",
                "https://news.ycombinator.com/",
                "Hacker News"
              ),
            ]

          # De-duplicate by URL and keep at most 3 items
          seen = set()
          unique = []
          for title, url, source in articles:
            if url in seen:
              continue
            seen.add(url)
            unique.append((title, url, source))
            if len(unique) >= 3:
              break

          now = dt.datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC")

          # Build markdown block
          lines = [
            f"Last update: {now}",
            "",
          ]
          for title, url, source in unique:
            lines.append(f"- [{title}]({url}) â€” {source}")

          block = "\n".join(lines)

          readme = README_PATH.read_text(encoding="utf-8")

          pattern = re.compile(
            re.escape(START) + r"[\s\S]*?" + re.escape(END),
            flags=re.M,
          )
          replacement = f"{START}\n{block}\n{END}"

          if pattern.search(readme):
            updated = pattern.sub(replacement, readme)
          else:
            updated = readme.rstrip() + "\n\n" + replacement + "\n"

          README_PATH.write_text(updated, encoding="utf-8")
          PY

      - name: Commit and push
        env:
          GH_TOKEN: ${{ secrets.PAT_PUSH }}
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "Aviv Geron"
          git config user.email "geron.aviv@hotmail.com"

          if ! git diff --quiet; then
            git add README.md
            git commit -m "chore: daily AI multi-source news summary"
            git push "https://x-access-token:${GH_TOKEN}@github.com/${{github.repository}}" HEAD
          else
            echo "No changes to commit"
          fi
